<html>

<head>
    <style>
        .yt-video-link {
            display: inline-grid;
            font-family: sans-serif;
            margin-top: 5px;
            margin: 5px;
            width: min-content;
            color: white;
            text-align: center;
        }

        .yt-thumbnail {
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .yt-player {
            display: nonse;
            float: left;
        }

        .yt-playlist {
            color: white;
            font-family: sans-serif;
            float: right;
            overflow: scroll;
            overflow-x: hidden;
            overflow-y: scroll;
            width: 50%;
            padding: 5px;
        }

        .yt-top-panel {
            top: 0px;
            position: fixed !important;
            background: black;
            display: inline-flex;
            width: 100%;
            height: 250px;
            overflow: auto;
            border-bottom: 3px solid white;
        }

        .yt-mainview {
            padding-top: 250px;
        }

        .yt-video-counter {
          font-family: sans-serif;
          color: white;
          background: black;
          position: fixed;
          right: 0px;
          top: 0px;
          margin: 3px;
        }

        a {
            text-decoration: none;
        }

        a:visited {
            color: blue;
        }

        body {
            background: black;
        }
    </style>

    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.5.1.min.js"></script>
    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.10/jquery-ui.min.js"></script>
    <link href="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.10/themes/ui-lightness/jquery-ui.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div id="top-panel" class="yt-top-panel">
        <div id="player" class="yt-player"></div>
        <div id="playlist" class="yt-playlist"></div>
    </div>
    <div id="mainview" class="yt-mainview"></div>
    <div id="video-counter" class="yt-video-counter"></div>


    <script>
        $("#top-panel").resizable({
            handles: 's'
        });

        $("#top-panel").resize(function() {
            console.log("ADFASFAF");
            var mainview = $("#mainview")[0];
            var tp = $("#top-panel")[0];
            tp.style.width = "100%";
            mainview.style.paddingTop = tp.style.height;
        });

        // YouTube Player
        ////////////////////////////////////////////
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player(
                'player', {
                    height: 'auto',
                    width: '50%',
                    videoId: getVid(),
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }

        function onPlayerStateChange(event) {
            console.log("State change: " + event);

            // The video has finished playing.
            if (event.data == 0) {
                console.log("Finished playing.")
                dequeueFromPlaylist();
            }
        }

        function stopVideo() {
            player.stopVideo();
        }

        function playInVox(vid) {
            var url = 'com.coppertino.vox://youtube/track/play?url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D' + vid;
            window.location.assign(url);
        }

        // Playlist
        ////////////////////////////////////////////
        var playlist = [];

        function renderPlaylist() {
            var view = document.getElementById("playlist");
            view.innerHTML = "";

            for (var i = playlist.length - 1; i >= 0; i--) {
                view.innerHTML += playlist[i]["title"] + '</br>';
            }
        }

        function enqueueToPlaylist(vid, title) {
            playlist.push({
                vid: vid,
                title: title
            });
            renderPlaylist();

            if (player !== undefined) {
                player.loadVideoById(vid);
            }
        }

        function dequeueFromPlaylist() {
            var entry = playlist.pop();
            renderPlaylist();

            if (player !== undefined) {
                player.loadVideoById(entry["vid"]);
            }
        }

        // Loading of related videos.
        ////////////////////////////////////////////
        function GetJSON(url, f) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'json';
            xhr.onload = function() {
                f(xhr.response);
            };
            xhr.send();
        }

        function addRelatedVideos(view, vid) {
            var key = 'AIzaSyDaPnpShE8nxyGs-QjX55r5qREcQhub-j8';
            var api_url = 'https://www.googleapis.com/youtube/v3/search?' +
                'maxResults=50' +
                '&part=snippet' +
                '&relatedToVideoId=' + vid +
                '&type=video' +
                '&key=' + key;

            var f = function(response) {
                for (var i = 0; i < response["items"].length; i++) {
                    addVideoToVIew(
                        view,
                        response["items"][i]["id"]["videoId"],
                        response["items"][i]["snippet"]["title"],
                        response["items"][i]["snippet"]["thumbnails"]["high"]["url"]
                    );
                }

                var npt = response['nextPageToken'];
                if (npt !== undefined) {
                    GetJSON(api_url + '&pageToken=' + npt, f);
                }
            }
            GetJSON(api_url, f);
        }

        function disableLoadingRelated(vid, title) {
            return 'document.getElementById("' + vid +
                '").setAtribute("onclick","' + makeEnqueueScript(vid, title) + '")';
        }

        function makeEnqueueScript(vid, title) {
            return 'enqueueToPlaylist("' + vid + '","' + title + '");';
        }

        var videoCount = 0;
        var addedVideos = [];
        function addVideoToVIew(view, vid, title, thumb) {
            if (addedVideos[vid] !== undefined) {
              console.log("Already added video: " + title);
              return;
            }
            videoCount++;
            $("#video-counter")[0].innerHTML = "" + videoCount;

            addedVideos[vid] = true;

            var img = document.createElement('img');
            var onclick =
                makeEnqueueScript(vid, title) +
                'addRelatedVideos("' + vid + '");' +
                disableLoadingRelated(vid, title);
            //img.setAttribute('onClick', onclick);
            img.setAttribute('src', thumb);
            img.setAttribute('class', 'yt-thumbnail');
            img.setAttribute('id', vid);

            var a = document.createElement('a');
            a.setAttribute('class', 'yt-video-link');
            a.setAttribute('href', '#' + vid);
            a.appendChild(img);
            a.innerHTML += title;

            view.appendChild(a);

            var ii = document.getElementById(vid);
            ii.onclick = function() {
                enqueueToPlaylist(vid, title);
                addRelatedVideos(view, vid);
                ii.onclick = function() {
                    enqueueToPlaylist(vid, title);
                };
            };
        }

        function getVid() {
            return window.location.hash.substring(1);
        }

        document.body.onload = function() {
            var mainView = document.getElementById("mainview");
            addRelatedVideos(mainView, getVid());
        }

    </script>
</body>

</html>
